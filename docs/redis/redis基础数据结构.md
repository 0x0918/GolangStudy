# 1、redis 基础数据结构

## 1.1 简单动态字符串

### 1.1.1 基本概念
redis 没有直接使用 C 语言的传统字符串表示，而是自己构建了一种名为简单动态字符串（simple dynamic string,SDS）的抽象类型。

SDS 遵循 C 字符串以空字符结尾的惯例，保存空字符的 1 字节空间不计算在 SDS 的 len 属性里面，遵循惯例的好处是，SDS 可以直接重用一部分 C 函数库里的函数。

```c
/*
 * 保存字符串对象的结构
 */
struct sdshdr {
    
    // buf 中已占用空间的长度
    int len;

    // buf 中剩余可用空间的长度
    int free;

    // 数据空间
    char buf[];
};
```

### 1.1.2 SDS 与 C 字符串的区别
因为 SDS 在 len 属性中记录了长度，所以 SDS 获取长度复杂度为 O(1)。而 C 字符串获取长度的复杂度为 O(N)。

C 字符串不记录长度容易造成缓冲区溢出，SDS 的空间分配策略完全杜绝了发生缓冲区溢出的可能：当 SDS API 需要对 SDS 进行修改时，API 会自动将 SDS 的空间扩展至执行修改所需的大小。

每次增长或缩短一个 C 字符串，程序都总要对保存这个 C 字符串的数组进行一次内存重新分配操作。
- 如果增长字符串，例如 append，那么需要先通过内存重新分配来扩展数组的空间，否则会产生缓冲区溢出。
- 如果缩短字符串，例如 trim，那么需要释放字符串不再使用的空间，否则会产生内存泄漏。

SDS 通过未使用空间避免了这种缺陷，在 SDS 中，buf 数组的长度不一定就是字符数量加一，数组里面包含未使用的字节，这些字节的数量由 free 属性记录。
